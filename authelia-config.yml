---
# Authelia Configuration for Seance - Templated for dev/prod
# https://www.authelia.com/configuration/prologue/introduction/
# Enable templating: X_AUTHELIA_CONFIG_FILTERS=template

theme: light

server:
  address: 'tcp://0.0.0.0:9091'

log:
  level: debug
  format: text

# Session configuration - stored in Redis/Valkey
session:
  secret: 'insecure_dev_session_secret_change_in_production'  # TODO: Use secrets management in prod
  name: seance_session
  same_site: lax
  expiration: 1h
  inactivity: 15m
  remember_me: 1M

  cookies:
    - domain: '{{ env "AUTH_DOMAIN" | trimPrefix "auth." }}'  # localhost or seance.dev
      authelia_url: 'https://{{ env "AUTH_DOMAIN" }}'
      default_redirection_url: 'https://{{ env "CADDY_DOMAIN" }}'

  redis:
    host: localhost
    port: 6379

# Storage backend for user settings, TOTP secrets, etc.
storage:
  encryption_key: 'insecure_dev_encryption_key_must_be_at_least_20_chars'
  local:
    path: /tmp/authelia/db.sqlite3

# Authentication backend - file-based users for now
# In production, consider LDAP or external OAuth
authentication_backend:
  file:
    path: ./authelia-users.yml
    password:
      algorithm: argon2
      argon2:
        variant: argon2id
        iterations: 3
        memory: 65536
        parallelism: 4
        key_length: 32
        salt_length: 16

# Access control rules
access_control:
  default_policy: bypass  # Allow all by default, Express handles authorization

  rules:
    # Require authentication for dashboard (browser route)
    - domain:
        - '{{ env "CADDY_DOMAIN" }}'
        - '{{ env "APP_DOMAIN" }}'
        - '{{ env "MARKETING_DOMAIN" }}'
      policy: one_factor
      resources:
        - "^/dashboard.*"

# Identity validation for password resets and 2FA setup
identity_validation:
  reset_password:
    jwt_secret: 'insecure_dev_jwt_secret_change_in_production_must_be_long'

# Notifier configuration - for now, just use file-based (no email)
# In production, configure SMTP for password resets
notifier:
  filesystem:
    filename: /tmp/authelia/notifications.txt

# TOTP (Time-based One-Time Password) for 2FA
totp:
  issuer: seance.dev
  period: 30
  skew: 1
