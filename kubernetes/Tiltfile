# Tilt configuration for Seance local development
# This gives us hot reload in Kubernetes - the best of both worlds

# Ensure we're using the local kind cluster
allow_k8s_contexts('kind-seance-local')

# Build backend image with live reload
docker_build(
  'seance-backend',
  context='../backend-trpc',
  dockerfile='../images/backend.dockerfile',
  live_update=[
    # Sync source files for hot reload
    sync('../backend-trpc/src', '/app/src'),
    sync('../backend-trpc/package.json', '/app/package.json'),
    # Restart the process when package.json changes
    run('cd /app && npm install', trigger=['../backend-trpc/package.json']),
  ],
)

# Build landing page image with Vite HMR
docker_build(
  'seance-landing',
  context='../landing-page',
  dockerfile='../images/landing.dockerfile',
  live_update=[
    sync('../landing-page/src', '/app/src'),
    sync('../landing-page/index.html', '/app/index.html'),
    sync('../landing-page/package.json', '/app/package.json'),
    run('cd /app && npm install', trigger=['../landing-page/package.json']),
  ],
)

# Generate k8s manifests from cdk8s
local_resource(
  'cdk8s-synth',
  cmd='cd cdk8s && npm run synth',
  deps=['cdk8s/src', 'cdk8s/imports'],
  labels=['infrastructure'],
)

# Apply cert-manager first (CRDs + controllers)
k8s_yaml('./cdk8s/dist/cert-manager.k8s.yaml')

# Configure cert-manager resources
k8s_resource(
  'cert-manager',
  labels=['infrastructure'],
)

k8s_resource(
  'cert-manager-webhook',
  labels=['infrastructure'],
)

k8s_resource(
  'cert-manager-cainjector',
  labels=['infrastructure'],
)

# Apply seance resources after cert-manager is ready
# Note: First apply may fail if webhook isn't ready - Tilt will auto-retry
k8s_yaml('./cdk8s/dist/seance.k8s.yaml')

# Port forwards for local access
# All app resources depend on cert-manager being ready (for ClusterIssuers)
k8s_resource(
  'backend',
  port_forwards=[
    '8765:8765',  # Backend API
  ],
  labels=['backend'],
  resource_deps=['cert-manager', 'cert-manager-webhook'],
)

k8s_resource(
  'landing',
  port_forwards=[
    '5928:5928',  # Vite HMR
  ],
  labels=['frontend'],
  resource_deps=['cert-manager', 'cert-manager-webhook'],
)

k8s_resource(
  'signaling',
  port_forwards=[
    '4444:4444',  # WebRTC signaling
  ],
  labels=['infrastructure'],
  resource_deps=['cert-manager', 'cert-manager-webhook'],
)

k8s_resource(
  'valkey',
  port_forwards=[
    '6379:6379',  # Redis
  ],
  labels=['infrastructure'],
  resource_deps=['cert-manager', 'cert-manager-webhook'],
)

# Ingress is automatically applied from the manifest
# No need to manage it separately in Tilt

print("""
üîÆ Seance Kubernetes Development

Local URLs (via Ingress with TLS):
  Marketing: https://dev.localhost
  Backend: https://backend.dev.localhost
  App: https://app.dev.localhost

Direct access (port-forward):
  Backend: http://localhost:8765
  Landing: http://localhost:5928
  Signaling: ws://localhost:4444
  Valkey: localhost:6379

‚ö†Ô∏è  Self-signed certificates: Your browser will show security warnings.
    Click 'Advanced' ‚Üí 'Proceed to localhost' to continue.

First time setup:
  Run: ./setup.sh
  Then: tilt up
""")
