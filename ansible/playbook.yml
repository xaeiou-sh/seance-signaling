---
# Ansible playbook to provision Seance backend server on Ubuntu 24.04
# Uses Zellij for easy debugging - ssh in and `zellij attach seance-production`

- name: Provision Seance Backend Server
  hosts: seance
  become: yes
  vars:
    repo_url: "https://github.com/xaeiou-sh/seance-signaling.git"
    repo_branch: "main"
    install_dir: "/mycorrhiza/seance-signaling"
    data_dir: "/mycorrhiza/seance-data"
    nix_installer_url: "https://nixos.org/nix/install"
    zellij_session_name: "seance-production"

  tasks:
    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required system packages
      apt:
        name:
          - curl
          - git
          - ca-certificates
          - gnupg
          - xz-utils
        state: present

    - name: Check if Zellij is installed
      stat:
        path: /usr/local/bin/zellij
      register: zellij_installed

    - name: Download Zellij binary
      get_url:
        url: https://github.com/zellij-org/zellij/releases/latest/download/zellij-x86_64-unknown-linux-musl.tar.gz
        dest: /tmp/zellij.tar.gz
      when: not zellij_installed.stat.exists

    - name: Extract Zellij to /usr/local/bin
      unarchive:
        src: /tmp/zellij.tar.gz
        dest: /usr/local/bin/
        remote_src: yes
        mode: '0755'
      when: not zellij_installed.stat.exists

    - name: Check if Nix is already installed
      stat:
        path: /nix/var/nix/profiles/default/bin/nix
      register: nix_installed

    - name: Install Nix (multi-user)
      shell: |
        curl -L {{ nix_installer_url }} | sh -s -- --daemon --yes
      when: not nix_installed.stat.exists
      register: nix_install

    - name: Add Nix to PATH for all users
      lineinfile:
        path: /etc/profile.d/nix.sh
        line: '. /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
        create: yes
        mode: '0755'

    - name: Install devenv via Nix
      shell: |
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        nix profile install --accept-flake-config nixpkgs#devenv
      args:
        creates: /root/.nix-profile/bin/devenv
      environment:
        NIX_CONFIG: "experimental-features = nix-command flakes"

    - name: Install Docker dependencies
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
        state: present

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Create data directory
      file:
        path: "{{ data_dir }}"
        state: directory
        mode: '0755'

    - name: Clone repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ install_dir }}"
        version: "{{ repo_branch }}"
        force: yes

    - name: Create systemd service for Zellij session
      copy:
        dest: /etc/systemd/system/seance-backend.service
        content: |
          [Unit]
          Description=Seance Backend (Zellij Session)
          After=network-online.target docker.service
          Wants=network-online.target
          Requires=docker.service

          [Service]
          Type=forking
          Restart=always
          RestartSec=10
          WorkingDirectory={{ install_dir }}
          Environment="PATH=/root/.nix-profile/bin:/nix/var/nix/profiles/default/bin:/usr/local/bin:/usr/bin:/bin"
          ExecStart=/usr/bin/zellij --session {{ zellij_session_name }} --daemon -- bash -c '. /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh && cd {{ install_dir }} && devenv --profile prod up'

          # Stop by killing the session
          ExecStop=/usr/bin/zellij kill-session {{ zellij_session_name }}

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: Reload systemd

    - name: Enable and start seance-backend service
      systemd:
        name: seance-backend
        enabled: yes
        state: started
        daemon_reload: yes

  handlers:
    - name: Reload systemd
      systemd:
        daemon_reload: yes
