#!/usr/bin/env bash
# Railway utility script - shortcuts for common operations

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

case "${1:-help}" in
  deploy)
    # Full deployment (build + push + terraform + secrets)
    "$REPO_ROOT/scripts/deploy-railway.sh"
    ;;

  secrets)
    # Update secrets only
    "$REPO_ROOT/scripts/apply-railway-secrets.sh" production
    ;;

  status)
    # Show status of all services
    railway status
    ;;

  logs)
    # Show logs for a service
    if [ -z "$2" ]; then
      echo "Usage: $0 logs <service-name>"
      echo "Services: backend, landing, signaling, beholder, litellm, valkey"
      exit 1
    fi
    railway logs --service "$2" --tail 100
    ;;

  shell)
    # Open shell in a service container
    if [ -z "$2" ]; then
      echo "Usage: $0 shell <service-name>"
      echo "Services: backend, landing, signaling, beholder, litellm, valkey"
      exit 1
    fi
    railway run --service "$2" bash
    ;;

  domains)
    # List all custom domains and their CNAMEs
    railway domain list
    ;;

  vars)
    # Show environment variables for a service
    if [ -z "$2" ]; then
      echo "Usage: $0 vars <service-name>"
      echo "Services: backend, landing, signaling, beholder, litellm, valkey"
      exit 1
    fi
    railway variables --service "$2"
    ;;

  restart)
    # Restart a service
    if [ -z "$2" ]; then
      echo "Usage: $0 restart <service-name>"
      echo "Services: backend, landing, signaling, beholder, litellm, valkey"
      exit 1
    fi
    railway restart --service "$2"
    ;;

  plan)
    # Show Terraform plan (what would change)
    cd "$REPO_ROOT"
    export TF_VAR_git_commit=$(git rev-parse --short HEAD)
    tofu plan
    ;;

  help|*)
    cat <<EOF
Railway utility script - shortcuts for common operations

Usage: $0 <command> [args]

Commands:
  deploy          Full deployment (build + push + terraform + secrets)
  secrets         Update secrets only (from SOPS)
  status          Show status of all services
  logs <service>  Show logs for a service
  shell <service> Open shell in service container
  domains         List custom domains and CNAMEs
  vars <service>  Show environment variables for service
  restart <service> Restart a service
  plan            Show Terraform plan (dry-run)
  help            Show this help message

Services: backend, landing, signaling, beholder, litellm, valkey

Examples:
  $0 deploy                    # Full deployment
  $0 logs backend              # Show backend logs
  $0 restart litellm           # Restart LiteLLM service
  $0 vars backend              # Show backend environment variables
EOF
    ;;
esac
