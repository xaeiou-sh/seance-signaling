# Secrets Management

This project uses different secret management approaches for different contexts:

- **Development environment**: [SecretSpec](https://secretspec.dev) for local development secrets
- **Kubernetes deployments**: SOPS+age for encrypted secrets in git (see `secrets/README.md`)

## Overview

**SecretSpec separates secret declaration from secret provisioning:**
- `secretspec.toml` - Declares what secrets the project needs (checked into git)
- `.env` - Stores actual secret values (gitignored, never committed)
- `devenv.yaml` - Configures SecretSpec integration

## Quick Start

### 1. Initialize Secrets

```bash
# Copy example to create your local .env
cp .env.example .env

# Or let setup-zitadel-app create it for you
devenv up
setup-zitadel-app  # Auto-populates ZITADEL credentials in .env
```

### 2. Configure Secrets

Edit `.env` and fill in your values:

```bash
# Required for Zitadel
ZITADEL_MASTERKEY=MasterkeyNeedsToHave32Characters
POSTGRES_PASSWORD=your_secure_password

# Auto-generated by setup-zitadel-app
ZITADEL_CLIENT_ID=356276462078215221
ZITADEL_CLIENT_SECRET=...
VITE_ZITADEL_CLIENT_ID=356276462078215221

# Optional: Stripe keys
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRICE_ID=price_...
```

### 3. Access Secrets in Code

**In devenv.nix:**
```nix
env.ZITADEL_CLIENT_ID = config.secretspec.secrets.ZITADEL_CLIENT_ID or "";
```

**In your application:**
```typescript
// Secrets are available as environment variables
const clientId = process.env.ZITADEL_CLIENT_ID;
```

## Secret Definitions

All secrets are defined in `secretspec.toml`:

```toml
[profiles.default]
ZITADEL_MASTERKEY = {
  description = "Zitadel encryption master key (32 bytes)",
  required = true,
  default = "MasterkeyNeedsToHave32Characters"
}

ZITADEL_CLIENT_ID = {
  description = "Zitadel OIDC application client ID",
  required = false,
  default = ""
}
# ... more secrets
```

## Secret Providers

SecretSpec supports multiple providers (configured in `devenv.yaml`):

### Current Setup: dotenv (Development)
```yaml
secretspec:
  enable: true
  provider: dotenv  # Stores secrets in .env file
  profile: default
```

### Production: Use Keyring or 1Password
```yaml
secretspec:
  enable: true
  provider: keyring  # macOS Keychain, Windows Credential Manager, Linux Secret Service
  profile: production
```

Or:
```yaml
secretspec:
  enable: true
  provider: 1password
  profile: production
```

## Generating Secure Values

### Zitadel Master Key (32 bytes)
```bash
openssl rand -base64 32 | head -c 32
```

### Postgres Password
```bash
openssl rand -hex 20
```

### Builder Key
```bash
openssl rand -hex 32
```

## Security Best Practices

### ✅ DO
- Keep `.env` file gitignored (already configured)
- Use `setup-zitadel-app` to auto-generate OIDC credentials
- Use strong, unique passwords for production
- Rotate secrets regularly in production
- Use `keyring` or `1password` provider for production

### ❌ DON'T
- Never commit `.env` to version control
- Never hardcode secrets in `devenv.nix`
- Never share `.env` file in Slack/email
- Never use development secrets in production

## Automation Scripts

### setup-zitadel-app
Automatically creates Zitadel OIDC application and updates `.env`:

```bash
setup-zitadel-app
```

**What it does:**
1. Creates "Seance" project in Zitadel
2. Creates "Seance Web" OIDC application
3. Writes CLIENT_ID and CLIENT_SECRET to `.env`
4. Idempotent - safe to run multiple times

## Troubleshooting

### "Secret not found" errors
**Problem:** devenv can't find a secret from `.env`

**Solution:**
```bash
# Check if .env exists and has the secret
cat .env | grep ZITADEL_CLIENT_ID

# Restart devenv to reload secrets
devenv up
```

### Missing CLIENT_ID/CLIENT_SECRET
**Problem:** Secrets are empty after starting

**Solution:**
```bash
# Run the setup script to generate credentials
setup-zitadel-app

# Restart devenv to load new secrets
devenv up
```

### "masterkey must be 32 bytes" error
**Problem:** ZITADEL_MASTERKEY is wrong length

**Solution:**
```bash
# Generate a proper 32-byte key
openssl rand -base64 32 | head -c 32

# Update .env
echo "ZITADEL_MASTERKEY=$(openssl rand -base64 32 | head -c 32)" >> .env
```

## Migration from Hardcoded Secrets

If you have hardcoded secrets in `devenv.nix`, migrate them:

### Before (hardcoded):
```nix
env.ZITADEL_CLIENT_ID = "356276462078215221";
env.ZITADEL_CLIENT_SECRET = "O6ET6thqA0sfwlsykvsJ...";
```

### After (secretspec):
```nix
env.ZITADEL_CLIENT_ID = config.secretspec.secrets.ZITADEL_CLIENT_ID or "";
env.ZITADEL_CLIENT_SECRET = config.secretspec.secrets.ZITADEL_CLIENT_SECRET or "";
```

And add to `.env`:
```bash
ZITADEL_CLIENT_ID=356276462078215221
ZITADEL_CLIENT_SECRET=O6ET6thqA0sfwlsykvsJ...
```

## Kubernetes Secrets (SOPS+age)

For Kubernetes deployments, secrets are managed separately from manifests using SOPS and age encryption:

- **Location**: `secrets/secrets.yaml` (encrypted, safe to commit)
- **Deployment**: Secrets applied directly to cluster via `kubectl` (never in manifests)
- **Security**: Generated Kubernetes manifests contain NO secret values
- **Documentation**: See `secrets/README.md` for complete guide

**How it works:**
1. Secrets encrypted with SOPS+age in `secrets/secrets.yaml`
2. Deployment script decrypts and applies to cluster: `kubectl create secret`
3. Kubernetes manifests only reference the secret via `secretKeyRef`
4. No secret values ever stored in git or generated YAML files

**Quick setup:**
```bash
# Install SOPS
nix-env -iA nixpkgs.sops

# Edit secrets (auto-encrypts on save)
sops secrets/secrets.yaml
```

**Apply to cluster:**
```bash
# Production
./scripts/deploy-production.sh  # Auto-applies secrets

# Development
tilt up  # Auto-applies secrets to local cluster
```

## Resources

- [SecretSpec Documentation](https://secretspec.dev)
- [devenv SecretSpec Integration](https://devenv.sh/integrations/secretspec/)
- [Announcing SecretSpec](https://devenv.sh/blog/2025/07/21/announcing-secretspec-declarative-secrets-management/)
- [SOPS Documentation](https://github.com/getsops/sops)
- [age Encryption](https://age-encryption.org/)
