# Caddy reverse proxy for Seance backend
# Configured via environment variables set in devenv.nix

{
	admin off
}

# Backend domain (set by CADDY_DOMAIN env var)
{$CADDY_DOMAIN} {
	# PostHog reverse proxy - routes analytics through our domain to bypass ad blockers
	# Enable CORS for all domains to avoid debugging issues
	@beholder_static {
		path /beholder/static*
	}
	handle @beholder_static {
		# Handle preflight requests first
		@options {
			method OPTIONS
		}
		handle @options {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization"
			respond 204
		}

		handle {
			# Strip /beholder prefix, keeping /static/ path
			uri strip_prefix /beholder
			reverse_proxy https://us-assets.i.posthog.com:443 {
				header_up Host us-assets.i.posthog.com
				# Preserve the Origin header from the client
				header_up Origin {http.request.header.Origin}
				# Remove any CORS headers from upstream to prevent duplicates
				header_down -Access-Control-Allow-Origin
				header_down -Access-Control-Allow-Methods
				header_down -Access-Control-Allow-Headers
				header_down -Access-Control-Allow-Credentials
			}
			# Set our own CORS headers after removing upstream's
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization"
		}
	}

	@beholder {
		path /beholder*
	}
	handle @beholder {
		# Handle preflight requests first
		@options {
			method OPTIONS
		}
		handle @options {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization"
			respond 204
		}

		handle {
			# Strip /beholder prefix before proxying to PostHog
			uri strip_prefix /beholder
			reverse_proxy https://us.i.posthog.com:443 {
				header_up Host us.i.posthog.com
				# Preserve the Origin header from the client
				header_up Origin {http.request.header.Origin}
				# Remove any CORS headers from PostHog's response to prevent duplicates
				header_down -Access-Control-Allow-Origin
				header_down -Access-Control-Allow-Methods
				header_down -Access-Control-Allow-Headers
				header_down -Access-Control-Allow-Credentials
			}
			# Set our own CORS headers after removing PostHog's
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization"
		}
	}

	# WebRTC signaling server
	@signaling {
		path /signaling*
	}
	handle @signaling {
		header Access-Control-Allow-Origin "*"
		header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		header Access-Control-Allow-Headers "Content-Type, Authorization"

		@options {
			method OPTIONS
		}
		handle @options {
			respond 204
		}

		handle {
			reverse_proxy localhost:4444 {
				header_up Host {host}
				header_up X-Real-IP {remote_host}
			}
		}
	}

	# Default: backend API/update server
	handle {
		header Access-Control-Allow-Origin "*"
		header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		header Access-Control-Allow-Headers "Content-Type, Authorization"

		@options {
			method OPTIONS
		}
		handle @options {
			respond 204
		}

		reverse_proxy localhost:3000 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
		}
	}

	log {
		output stderr
		format console
	}
}

# App domain (set by APP_DOMAIN env var)
{$APP_DOMAIN} {
	header Access-Control-Allow-Origin "*"
	header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
	header Access-Control-Allow-Headers "Content-Type, Authorization"

	@options {
		method OPTIONS
	}
	handle @options {
		respond 204
	}

	reverse_proxy localhost:3000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	log {
		output stderr
		format console
	}
}
