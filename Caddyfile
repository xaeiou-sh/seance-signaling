# Caddy reverse proxy for Seance backend
# Configured via environment variables set in devenv.nix
# Uses .localhost domains with automatic HTTPS for local development

{
	admin off
	# Automatic HTTPS is enabled by default for all domains
}

# Authelia authentication server
{$AUTH_DOMAIN} {
	reverse_proxy localhost:9091 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	log {
		output stderr
		format console
	}
}

# Backend domain (set by CADDY_DOMAIN env var)
{$CADDY_DOMAIN} {
	# Define browser routes that require authentication (redirects to Authelia login)
	@dashboard {
		path /dashboard*
	}

	# Forward authentication to Authelia for browser routes
	# This redirects unauthenticated users to Authelia login page
	handle @dashboard {
		forward_auth {$AUTH_DOMAIN} {
			uri /api/verify?rd=https://{$CADDY_DOMAIN}/
			copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
		}
	}

	# API routes (/api/*, /trpc/*) do NOT use forward_auth
	# Express validates sessions directly via cookies for fine-grained control
	# PostHog reverse proxy - routes analytics through our domain to bypass ad blockers
	# Enable CORS for all domains to avoid debugging issues
	@beholder_static {
		path /beholder/static*
	}
	handle @beholder_static {
		# Handle preflight requests first
		@options {
			method OPTIONS
		}
		handle @options {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization"
			respond 204
		}

		handle {
			# Strip /beholder prefix, keeping /static/ path
			uri strip_prefix /beholder
			reverse_proxy https://us-assets.i.posthog.com:443 {
				header_up Host us-assets.i.posthog.com
				# Preserve the Origin header from the client
				header_up Origin {http.request.header.Origin}
				# Remove any CORS headers from upstream to prevent duplicates
				header_down -Access-Control-Allow-Origin
				header_down -Access-Control-Allow-Methods
				header_down -Access-Control-Allow-Headers
				header_down -Access-Control-Allow-Credentials
			}
			# Set our own CORS headers after removing upstream's
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization"
		}
	}

	@beholder {
		path /beholder*
	}
	handle @beholder {
		# Handle preflight requests first
		@options {
			method OPTIONS
		}
		handle @options {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization"
			respond 204
		}

		handle {
			# Strip /beholder prefix before proxying to PostHog
			uri strip_prefix /beholder
			reverse_proxy https://us.i.posthog.com:443 {
				header_up Host us.i.posthog.com
				# Preserve the Origin header from the client
				header_up Origin {http.request.header.Origin}
				# Remove any CORS headers from PostHog's response to prevent duplicates
				header_down -Access-Control-Allow-Origin
				header_down -Access-Control-Allow-Methods
				header_down -Access-Control-Allow-Headers
				header_down -Access-Control-Allow-Credentials
			}
			# Set our own CORS headers after removing PostHog's
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization"
		}
	}

	# WebRTC signaling server
	@signaling {
		path /signaling*
	}
	handle @signaling {
		reverse_proxy localhost:4444 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
		}
	}

	# Default: backend API/update server
	handle {
		reverse_proxy localhost:3000 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
		}
	}

	log {
		output stderr
		format console
	}
}

# App domain (set by APP_DOMAIN env var)
{$APP_DOMAIN} {
	reverse_proxy localhost:3000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	log {
		output stderr
		format console
	}
}

# Marketing site (set by MARKETING_DOMAIN env var)
{$MARKETING_DOMAIN} {
	# In dev mode: proxy to Vite dev server for hot reload
	# In prod mode: build first with `build-landing`, then this will serve static files

	# For dev: proxy to Vite dev server on port 5173
	reverse_proxy localhost:{$VITE_DEV_PORT:5173} {
		# Send proper headers for Vite HMR
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	# Compression
	encode gzip

	log {
		output stderr
		format console
	}
}
