# Caddy reverse proxy for Seance backend
# Configured via environment variables set in devenv.nix

{
	admin off
}

# Backend domain (set by CADDY_DOMAIN env var)
{$CADDY_DOMAIN} {
	# PostHog reverse proxy - routes analytics through our domain to bypass ad blockers
	handle_path /beholder/static* {
		rewrite * /static/{path}
		reverse_proxy https://us-assets.i.posthog.com:443 {
			header_up Host us-assets.i.posthog.com
			header_down -Access-Control-Allow-Origin
		}
	}

	handle_path /beholder* {
		rewrite * {path}
		reverse_proxy https://us.i.posthog.com:443 {
			header_up Host us.i.posthog.com
			header_down -Access-Control-Allow-Origin
		}
	}

	# WebRTC signaling server
	handle_path /signaling* {
		reverse_proxy localhost:4444 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
		}
	}

	# Default: backend API/update server
	handle {
		reverse_proxy localhost:3000 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
		}
	}

	log {
		output stderr
		format console
	}
}

# App domain (set by APP_DOMAIN env var)
{$APP_DOMAIN} {
	reverse_proxy localhost:3000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}
	log {
		output stderr
		format console
	}
}
